
## Vuex

### ç®€è¿°ä¸€ä¸‹ä»€ä¹ˆæ˜¯vuexï¼Ÿ

- vue çš„çŠ¶æ€ç®¡ç†æ¨¡å¼
- é›†ä¸­å¼å­˜å‚¨ç»„ä»¶é—´å…±äº«çš„çŠ¶æ€
- ä¿è¯çŠ¶æ€ä»¥å¯é¢„æµ‹çš„æ–¹å¼è¿›è¡Œæ›´æ–°  
- ç»´æŠ¤äº†vueçš„æ ¸å¿ƒç†å¿µï¼šå•å‘æ•°æ®æµ![image.png](https://cdn.nlark.com/yuque/0/2020/png/481272/1582461839496-77a43f95-f83b-4229-90ea-1350348eacd3.png#align=left&display=inline&height=267&margin=%5Bobject%20Object%5D&name=image.png&originHeight=866&originWidth=1280&size=53747&status=done&style=none&width=394)

å½“å¤šä¸ªç»„ä»¶å…±äº«ä¸€ä¸ªçŠ¶æ€æ—¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

- å¤šä¸ªè§†å›¾å…±äº«ä¸€ä¸ªçŠ¶æ€
- å¤šä¸ªè§†å›¾å­˜åœ¨ä¸åŒè¡Œä¸ºæ›´æ”¹åŒä¸€çŠ¶æ€

å› æ­¤é€šè¿‡**å…¨å±€å•ä¾‹æ¨¡å¼**ï¼Œèƒ½å¤Ÿåœ¨ä»»ä½•ç»„ä»¶ä¸­è·å–å…±äº«çš„çŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥è§¦å‘æŒ‡å®šè¡Œä¸ºä¿®æ”¹çŠ¶æ€ã€‚

> å®ç°å•ä¾‹æ¨¡å¼æ˜¯åœ¨ `install` æ–¹æ³•ä¸­å¯¹ä¼ å…¥çš„Vueè¿›è¡Œä¸€ä¸ªæ ¡éªŒï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™å–æ¶ˆæœ¬æ¬¡åŠ è½½Vuex 

**æµç¨‹å›¾å¦‚ä¸‹ï¼š**
![image.png](https://cdn.nlark.com/yuque/0/2020/png/481272/1581983107677-33fc2639-1cdb-4c86-8022-25bb87505d17.png#align=left&display=inline&height=276&margin=%5Bobject%20Object%5D&name=image.png&originHeight=551&originWidth=701&size=33979&status=done&style=none&width=350.5)

### action å’Œ mutationsçš„åŒºåˆ«ï¼Ÿ

ä½ ä¸èƒ½ç›´æ¥æ”¹å˜ store ä¸­çš„çŠ¶æ€ã€‚æ”¹å˜ store ä¸­çš„çŠ¶æ€çš„å”¯ä¸€é€”å¾„å°±æ˜¯æ˜¾å¼åœ°æäº¤ (commit) mutationã€‚mutations æ›´æ”¹çŠ¶æ€æœ€å¥½æ˜¯åŒæ­¥æ›´æ”¹ï¼Œè™½ç„¶å¼‚æ­¥æ›´æ”¹çŠ¶æ€ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæŠ¥é”™ã€‚

> ä¹Ÿå¥½ç†è§£ï¼šå¼‚æ­¥æ“ä½œå·²ç»è„±ç¦»äº†å½“å‰çš„mutationsï¼Œå±äºçªå˜å¤–çš„çŠ¶æ€æ›´æ”¹ï¼Œä¸å¯æ§ï¼Œå› æ­¤ç»™ç¦æ‰äº†


action æäº¤çš„æ˜¯ mutationè€Œä¸æ˜¯ç›´æ¥è¿›è¡ŒçŠ¶æ€ä¿®æ”¹ï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„å¼‚æ­¥æ“ä½œ

> å¯ä»¥ç†è§£ä¸ºreduxä¸­é—´ä»¶ï¼Ÿ

### å¦‚ä½•åŒºåˆ† vuex å’Œ props çš„ç•Œé™ï¼Ÿ

é€šå¸¸åœ¨ä¸šåŠ¡ç»„ä»¶ä¸­ï¼Œä½¿ç”¨vuexæ›´å¤šä¸€äº›ã€‚è¿™æ ·å¯ä»¥åœ¨ä¸åŒç»„ä»¶ä¸­ç»Ÿä¸€æ“ä½œvuexçš„çŠ¶æ€ï¼Œä½¿å¾—çˆ¶å­ç»„ä»¶é€šä¿¡ã€å…„å¼Ÿç»„ä»¶é€šä¿¡å’Œéš”ä»£ç»„ä»¶é€šä¿¡å˜å¾—æ¸…æ™°æ˜äº†ã€‚

åœ¨é€šç”¨ç»„ä»¶ä¸­ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨props å’Œ äº‹ä»¶è¿›è¡Œçˆ¶å­ç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼ˆé€šç”¨ç»„ä»¶é€šå¸¸ä¸å­˜åœ¨å…„å¼Ÿç»„ä»¶ä¹‹é—´é€šä¿¡ï¼‰ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯èƒ½å’Œä¸šåŠ¡è¿›è¡Œè§£è€¦ï¼Œæ–¹ä¾¿ç»„ä»¶çš„å¤ç”¨ã€‚

> å› æ­¤åœ¨è®¾è®¡é€šç”¨ç»„ä»¶æ—¶ï¼Œéœ€è¦å°†propsè¿›è¡Œè¯¦ç»†çš„è§„å®šï¼ˆè‡³å°‘ç»™ä¸Šç±»å‹åˆ¤æ–­ï¼‰ã€‚è¿™æ ·ä½¿å¾—ä½¿ç”¨è¯¥ç»„ä»¶çš„åŒäº‹å¾ˆèˆ’æœï¼Œå¹¶ä¸”åœ¨å¼€å‘ç¯å¢ƒä¸‹èƒ½å¤Ÿæ›´å¥½çš„debugã€‚

### vuexæ˜¯å¦‚ä½•å®‰è£…åˆ°vueä¸­çš„ï¼Ÿ

é¦–å…ˆåœ¨é¡¹ç›®ä¸­é€šè¿‡`Vue.use( plugin )`å°†vuexè¿›è¡Œå®‰è£…,é€šè¿‡è¯¥apiæˆ‘ä»¬çŸ¥é“æ’ä»¶è¦ä¹ˆæ˜¯ä¸€ä¸ªæä¾›äº†`install `æ–¹æ³•çš„å¯¹è±¡ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå½“åš`install`æ–¹æ³•è¿›è¡Œæ‰§è¡Œã€‚

å› æ­¤vuexåªéœ€è¦æä¾›`install` æ–¹æ³•ä½œä¸ºæ¡¥æ¢æ¥å£å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œuseæ–¹æ³•æ˜ç¡®äº†æ’ä»¶åœ¨å®ç°install æ–¹æ³•æ—¶éœ€è¦ä¿è¯åªèƒ½è¢«å®‰è£…ä¸€æ¬¡ï¼ˆä¹Ÿå°±æ˜¯å…¨å±€å•ä¾‹æ¨¡å¼ï¼‰

```js
// STEP 0.æ’ä»¶æ¡¥æ¢æ–¹æ³•
// é€šè¿‡Vue.use(Vuex)å³å¯è‡ªåŠ¨è°ƒç”¨installï¼Œä¼šå°†å½“å‰çš„Vueå®ä¾‹ä½œä¸º_Vueä¼ é€’è¿›æ¥
// ç¬¬ä¸‰æ–¹æ’ä»¶å¿…é¡»æä¾›installæ–¹æ³•
export function install (_Vue) {
  // ä¿è¯å…¨å±€å•ä¾‹æ¨¡å¼
  if (Vue && _Vue === Vue) {
    if (__DEV__) {
      console.error(
        '[vuex] already installed. Vue.use(Vuex) should be called only once.'
      )
    }
    return
	}  
  Vue = _Vue	
  // STEP 1.å…¨ä½“æ··å…¥$storeğŸ¤ 
  applyMixin(Vue)
}
```

### å¦‚ä½•è®©æ‰€æœ‰ç»„ä»¶éƒ½èƒ½å¤Ÿè·å–$storeå±æ€§ï¼Ÿ

vuexç»™å‡ºäº†ä¸¤ç§æ–¹æ¡ˆï¼šåœ¨vueç‰ˆæœ¬å¤§äºç­‰äº2æ—¶ï¼Œä¼šé‡‡ç”¨mixinæ··å…¥ç”Ÿå‘½å‘¨æœŸæ–¹æ¡ˆï¼›å°äº2.0ç‰ˆæœ¬æ—¶ä¼šé‡‡ç”¨å‘Vueçš„åŸå‹å¯¹è±¡ä¸Šæ·»åŠ å±æ€§è¿™ç§æ–¹æ¡ˆã€‚

> å¾ˆæ˜æ˜¾ï¼Œå‘åŸå‹æ·»åŠ  $store å±æ€§ä¼šå¯¼è‡´ä¸éœ€è¦vuexçš„å®ä¾‹ä¹Ÿä¼šæ‹¥æœ‰$storeå±æ€§

å…·ä½“å®ç°æ˜¯å‘ç»„ä»¶æ··å…¥`beforeCreate ` hooksï¼Œå…¶ä¸­åŒ…å«äº†`vuexInit`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ‰§è¡Œåä¼šå°†$storeå±æ€§æŒ‚è½½åˆ°å½“å‰ç»„ä»¶ä¸Šï¼ˆä¹Ÿå°±æ˜¯Vueå®ä¾‹ï¼‰ã€‚

> éœ€è¦æ³¨æ„ï¼Œé€šè¿‡mixinæ··å…¥çš„ç”Ÿå‘½å‘¨æœŸæ˜¯è¦å…ˆäºç»„ä»¶å†…çš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œçš„ï¼Œæ˜¯å› ä¸ºmixinçš„å®ç°æ˜¯é€šè¿‡`mergeOptions(this.options,mixin)`è¿™ç§æ–¹å¼è¿›è¡Œåˆå¹¶ï¼Œåœ¨åˆå¹¶ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œä¼šç»´æŠ¤ä¸€ä¸ªstackæ¥å­˜æ”¾åŒåç”Ÿå‘½å‘¨æœŸï¼Œå› æ­¤ä¼šå…ˆæ‰§è¡Œmixinä¸­çš„æ–¹æ³•ï¼ˆæœ€åè¿›stackï¼‰ã€‚

æ‰¿æ¥ä¸Šæ®µä»£ç ä¸­çš„`STEP 1`
```js
export default function (Vue) {
  const version = Number(Vue.version.split('.')[0])

  if (version >= 2) {
    // å…¨å±€æ··å…¥ï¼Œä¼šå½±å“åé¢æ‰€æœ‰çš„æ¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼ˆç»„ä»¶ï¼‰
    Vue.mixin({ beforeCreate: vuexInit })
  } else {
    const _init = Vue.prototype._init
    Vue.prototype._init = function (options = {}) {
      options.init = options.init
        ? [vuexInit].concat(options.init)
        : vuexInit
      _init.call(this, options)
    }
  }
  /**
   * Vuex init hook, injected into each instances init hooks list.
   */
  //  NOTE: æ ¹å®ä¾‹ã€ ç»„ä»¶å®ä¾‹æŒ‚è½½$store
  function vuexInit() {
    const options = this.$options
    // store injection
    if (options.store) {
      this.$store = typeof options.store === 'function'
        ? options.store()
        : options.store
    // é€šè¿‡åˆ¤æ–­çˆ¶èŠ‚ç‚¹çš„$store æ¥å®ç°å­ç»„ä»¶çš„æŒ‚è½½
    } else if (options.parent && options.parent.$store) {
      this.$store = options.parent.$store
    }
  }
}
```

### vuexä¸­æ˜¯å¦‚ä½•å®ç°storeä¸­çš„å“åº”å¼æ•°æ®çš„ï¼Ÿ

å€Ÿç”¨äº†`Vue.js`çš„æ•°æ®ä¾¦æµ‹(ç›´æ¥å°†storeå±æ€§å¡åˆ°äº†ä¸€ä¸ªæ–°çš„Vueå®ä¾‹çš„dataå±æ€§ä¸­ï¼Œå¥½èªæ˜ğŸ¤”)

åœ¨Storeç±»çš„`constructoræ–¹æ³•`ä¸­ï¼Œä¸»è¦åšäº†ä¸‰ä»¶å¤§äº‹ï¼š
- æ ¼å¼åŒ–æ•°æ®ï¼Œå°†ç”¨æˆ·ä¼ å…¥çš„optionsæ ¼å¼åŒ–æˆä¾¿äºæ“ä½œçš„æ ‘çŠ¶ç»“æ„
- é€’å½’çš„å®‰è£…æ¨¡å—
- å°†æ•°æ®è¿›è¡Œå“åº”å¼å¤„ç†

```js
constructor() {
  ...
  // æ­¤æ—¶çš„stateæ˜¯å®‰è£…å®Œæ¯•æ¨¡å—åçš„root.state
  resetStoreVM(this, state)
}

function resetStoreVM (store, state, hot) {
  ...
// NOTE å°†stateè¿›è¡Œå“åº”å¼å¤„ç†ï¼Œå’ŒVueå¼ºè€¦åˆã€‚
// åç»­è¿˜éœ€è¦è¿›è¡Œä¸€å±‚ä»£ç†
  store._vm = new Vue({
    data: {
      $$state: state
    },
    computed
  })
  ...  
}
```
### vuex ä¸­çš„getteræ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

å’Œstoreå“åº”å¼å¤„ç†å¼‚æ›²åŒå·¥ï¼Œå€ŸåŠ©`Vue.js`ä¸­çš„è®¡ç®—å±æ€§æ¥å®ç°ã€‚ä½†æ˜¯åœ¨å®ç°æ—¶ï¼Œéœ€è¦æ³¨æ„ä¸¤ä¸ªå°é—®é¢˜ï¼š
- getter å†™æ³•æ˜¯å‡½æ•°ï¼Œä½†å®é™…ä¸Šæ˜¯å¯¹å‡½æ•°è¿”å›çš„å¯¹è±¡è¿›è¡Œä½¿ç”¨ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ
- å¦‚ä½•å°†æ‰€æœ‰getter æŒ‚è½½åˆ°`Vue.js`çš„è®¡ç®—å±æ€§ä¸­ï¼Ÿ

é€šè¿‡ä»¥ä¸‹ä»£ç ç®€è¦è¯´æ˜å…¶å®ç°æ€è·¯ï¼š

```js
const computed = {};
forEach(options.getters, (fn, key) => {
    computed[key] = () => { // é€šè¿‡è®¡ç®—å±æ€§ å®ç°æ‡’åŠ è½½
        return fn(this.state)
    }
    Object.defineProperty(this.getters, key, {
      // ä»£ç†
        get: () => this._vm[key]
    })
})
this._vm = new Vue({
    data: { 
        $$state: state
    },
    // è¿™é‡Œç›´æ¥ä»¥å¤„ç†å¥½çš„å¯¹è±¡ç›´æ¥æŒ‚è½½
    computed 
```
1. éå†getterä¸­çš„é”®å€¼å¯¹ï¼Œå°†æ¯ä¸ªå¯¹åº”çš„key æŒ‚è½½åˆ°computedå¯¹è±¡ä¸Šï¼Œå€¼å°±æ˜¯å¯¹åº”çš„å‡½æ•°æ‰§è¡Œåè¿”å›çš„å±æ€§ã€‚å¹¶å°†computedå¯¹è±¡æŒ‚åˆ°`Vue.js`ä¸­ï¼Œé€šè¿‡ä»–çš„è®¡ç®—å±æ€§è¿›è¡Œç®¡ç†ã€‚
2. å¯¹getters è¿›è¡Œä¸€å±‚ä»£ç†ï¼Œåšä¸€ä¸ªå­˜å–å™¨ã€‚è¿™æ ·å°±å¯ä»¥é€šè¿‡$store.gettersç›´æ¥è·å–`Vue.js`ç®¡ç†çš„è®¡ç®—å±æ€§ã€‚
### vuexï¼šcommit å’Œ mutations æ˜¯å¦‚ä½•å»ºç«‹è”ç³»çš„ï¼Ÿ

æœ¬è´¨ä¸Šæ˜¯é€šè¿‡**å‘å¸ƒè®¢é˜…æ¨¡å¼**æ¥å®ç°çš„ï¼Œvuexå…·ä½“çš„å®ç°è¿‡ç¨‹ç¨å¾®å¤æ‚ï¼Œæˆ‘å°†ä»–æŠ½è±¡æˆæç®€çš„ä»£ç ï¼Œè¯´æ˜æ„å›¾ï¼š

```js
    this._mutations = {};
    forEach(options.mutations, (fn, type) => {
        this._mutations[type] = (payload) => fn.call(this, this.state, payload)
    });
    this._actions = {};
    forEach(options.actions, (fn, type) => {
        this._actions[type] = (payload) => fn.call(this, this, payload)
    });
```

1. å¯¹ç”¨æˆ·ä¼ é€’çš„mutationså¯¹è±¡è¿›è¡Œéå†ï¼Œå°†æ¯ä¸€ä¸ªtypeå¯¹åº”çš„`mutationså‡½æ•°`è¿›è¡Œä¸€å±‚åŒ…è£…ï¼Œä½¿å¾—åœ¨æ‰§è¡Œæ—¶èƒ½å¤Ÿä¼ é€’`payload`,å¹¶ä¸”ä¿è¯thisæ‰§è¡Œç­‰ã€‚æœ€ç»ˆä¿å­˜åˆ°å½“å‰storeå®ä¾‹å±æ€§ä¸Šï¼ˆ**è®¢é˜…è¿‡ç¨‹**ï¼‰

```js
  commit = (type, payload) => {
      this._mutations[type](payload)
  }
  dispatch = (type, payload) => {
      this._actions[type](payload);
  }
```

2. åœ¨commit ä»¥åŠ dispatchå‡½æ•°æ‰§è¡Œæ—¶ï¼Œä»å½“å‰å®ä¾‹ä¸Šæ‰¾åˆ°å¯¹åº”çš„typeæ–¹æ³•ï¼Œå¹¶å°†payloadä½œä¸ºå…¥å‚æ‰§è¡Œè¯¥å‡½æ•°ï¼ˆ**å‘å¸ƒè¿‡ç¨‹**ï¼‰

> forEachæ–¹æ³•æ˜¯ä¸ºäº†èƒ½å¤Ÿéå†å¯¹è±¡ï¼Œå°†å¯¹è±¡çš„é”®å€¼å¯¹ä»¥å‚æ•°çš„å½¢å¼ä¼ å…¥åˆ°æŒ‡å®šçš„å‡½æ•°ä¸­ï¼Œå¹¶æ‰§è¡Œã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š

```js
 forEach = (obj = {}, fn) => {
     Object.keys(obj).forEach((key) => fn(obj[key], key))
 }
```



### æ¨¡å—æ˜¯å¦‚ä½•å®‰è£…çš„ï¼Ÿ

###